{% extends "quiz_app/layout.html" %}

{% block title %}
{{ quiz.title | title }}
{% endblock %}

{% block content %}

<div class="quiz-started">

	<div class="row inner">
		<div class="col-12 col-md-7 instructions">
			<h1 class="text-center">Instructions</h1>
			<ol class="instruction-list mx-auto my-0">
				{% for instruction in quiz.instructions.splitlines %}
				<li>{{ instruction }}</li>
				{% endfor %}
			</ol>
		</div>
		<div class="col-12 col-md-5 my-5 d-flex justify-content-center align-content-center" style="height: 100%;">
			<form method="POST" class="" style="min-width:250px; width:fit-content">
				{% csrf_token %}
				<input id="start" type="submit" class="start_test" value="Start Test">
			</form>
		</div>
	</div>

</div>
<script>
	let quiz_id = `{{ quiz.quiz_id}}`;
	let form = $("form");
	
	form.on("submit", function(e) {
		e.preventDefault();

		extra = {};
		{% for extra in quiz.extra.splitlines %}
		extra["{{extra}}"] = ("")
		{% endfor %}
		const keys = Object.keys(extra);
		const length = keys.length;

		const steps = Array.from(new Array(length), (x, i) => i + 1);
		const swalQueueStep = Swal.mixin({
			confirmButtonText: 'Forward',
			allowOutsideClick: false,
			allowEscapeKey: false,
			cancelButtonText: 'Back',
			progressSteps: steps,
			input: 'text',
			inputAttributes: {
				required: true
			},
			reverseButtons: true,
			validationMessage: 'This field is required'
		})

		const values = []
		let currentStep
		(async () => {
		for (currentStep = 0; currentStep < length;) {
			const result = await swalQueueStep.fire({
				title: `Enter ${keys[currentStep]}`,
				inputValue: extra[keys[currentStep]],
				showCancelButton: currentStep > 0,
				currentProgressStep: currentStep
			})

			if (result.value) {
				extra[keys[currentStep]] = result.value
				currentStep++
			} else if (result.dismiss === Swal.DismissReason.cancel) {
				currentStep--
			} else {
				break
			}
		}

		if (currentStep === steps.length) {
			Swal.fire({
				icon: 'info',
				title: 'Submitting',
				html: 'Please Wait!!!',
				position: 'center',
				showConfirmButton: false,
				allowOutsideClick: false,
				allowEscapeKey: false,
			});
			$.ajax({
				type: "POST",
				url: 'save_extra/',
				data: {
					quiz: "{{quiz.quiz_id}}",
					extra: JSON.stringify(extra),
					csrfmiddlewaretoken: $('input[name="csrfmiddlewaretoken"]').val()
				},
				success:function(success) {
					window.location.pathname = `{% url 'quiz' quiz.quiz_id %}`;
				},
				error:function(error) {
					Swal.close();
					if(error.status == 403 && error.responseJSON.error == "logged out") {
						Swal.fire({
							toast: true,
							position: 'top-end',
							icon: 'error',
							html: `You Have been logged out.<br>Please Login again.`,
							animation: true,
							timer: 3000,
							timerProgressBar: true,
							showConfirmButton: false,
						});
					} else {
						Swal.fire({
							toast: true,
							position: 'top-end',
							icon: 'error',
							html: `An Error Occured<br>Please Try Again`,
							animation: true,
							timer: 2000,
							timerProgressBar: true,
							showConfirmButton: false,
						});
					}
				}
			});
		}
		})()
	})


	{% comment %} let testStartBtn = document.getElementById("test-start-btn");
	testStartBtn.addEventListener("click", function(e){
		e.preventDefault();
		console.log("button clicked");
		alertForFullScreen();
		openFullScreen();
		window.location.pathname=`/quiz/${quiz_id}`;
	});

	function alertForFullScreen(){
		Swal.fire({
			icon: 'info',
			title: 'Full Screen',
			html: 'You are required to enter in Full Screen',
			position: 'top',
			timerProgressBar: false,
			showConfirmButton: true,
			// timer: 1500
		});
	}

	function openFullScreen(){
		document.documentElement.requestFullscreen();
		let elem = document.documentElement;
		if (elem.requestFullscreen) {
			elem.requestFullscreen();
		} else if (elem.webkitRequestFullscreen) { /* Safari */
			elem.webkitRequestFullscreen();
		} else if (elem.msRequestFullscreen) { /* IE11 */
			elem.msRequestFullscreen();
		}
	} {% endcomment %}
</script>

{% endblock %}