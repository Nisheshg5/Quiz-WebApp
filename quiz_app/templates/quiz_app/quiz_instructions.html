{% extends "quiz_app/layout.html" %}

{% block title %}
{{ quiz.title | title }}
{% endblock %}

{% block content %}

<div id="quiz_instruction">
	<div class="row">
		<div class="col-12 mb-4">
			<h1 class="text-center">Instructions</h1>
		</div>
	</div>
	<div class="row inner">
		<div class="col-12 col-md-8 instructions">
			<ol class="">
				{% for instruction in quiz.instructions.splitlines %}
				<li>{{ instruction }}</li>
				{% endfor %}
			</ol>
		</div>
		<div class="col-12 col-md-4 my-5">
			<form method="POST">
				{% csrf_token %}
				<input id="start" type="submit" class="start_test btn" value="Start Test">
			</form>
		</div>
	</div>

</div>
<script>
	let quiz_id = `{{ quiz.quiz_id}}`;
	let form = $("form");
	
	form.on("submit", function(e) {
		e.preventDefault();

		extra = {};
		{% for extra in quiz.extra.splitlines %}
		extra["{{extra}}"] = ("")
		{% endfor %}
		const keys = Object.keys(extra);
		const length = keys.length;

		const steps = Array.from(new Array(length), (x, i) => i + 1);
		const swalQueueStep = Swal.mixin({
			confirmButtonText: 'Forward',
			allowOutsideClick: false,
			allowEscapeKey: false,
			cancelButtonText: 'Back',
			progressSteps: steps,
			input: 'text',
			inputAttributes: {
				required: true
			},
			reverseButtons: true,
			validationMessage: 'This field is required'
		})

		const values = []
		let currentStep;


		if (navigator.mediaDevices === undefined) {
			navigator.mediaDevices = {};
		}

		if (navigator.mediaDevices.getUserMedia === undefined) {
			navigator.mediaDevices.getUserMedia = function (constraints) {

				var getUserMedia = navigator.webkitGetUserMedia || navigator.mozGetUserMedia;

				if (!getUserMedia) {
					return Promise.reject(new Error('getUserMedia is not implemented in this browser'));
				}

				return new Promise(function (resolve, reject) {
					getUserMedia.call(navigator, constraints, resolve, reject);
				});
			}
		}






		Swal.fire({
			title: 'Submit your Github username',
			html: `<video id="video" width="400px" height="300px" autoplay></video>`,
			showCancelButton: false,
			confirmButtonText: 'Check Webcam',
			showLoaderOnConfirm: true,
			allowOutsideClick: false,
			allowEscapeKey: false,
			preConfirm: (login) => {
				let video = document.getElementById("video");
				return navigator.mediaDevices.getUserMedia({ video: true })
				.then((stream) => {
					console.log("Camera Found");

					video.srcObject = stream;
					video.onloadedmetadata = (e) => {
						video.play();
					}
				})
				.catch((error) => {
					Swal.showValidationMessage(
						`Request failed: ${error}`
					)
					console.log(error.name + ": " + error.message);
				})
			},
		}).then((result) => {
			if (result.isConfirmed) {
				Swal.fire({
					title: 'Sweet!',
					text: 'Modal with a custom image.',
					imageUrl: 'https://unsplash.it/400/200',
					imageWidth: 400,
					imageHeight: 200,
					imageAlt: 'Custom image',
				}).then((result) => {
					if (result.isConfirmed) {
						Swal.fire({
							title: `${result.value.login}'s avatar`,
							imageUrl: result.value.avatar_url
						})
					}
				})
			}
		})




		{% comment %} (async () => {
		for (currentStep = 0; currentStep < length;) {
			const result = await swalQueueStep.fire({
				title: `Enter ${keys[currentStep]}`,
				inputValue: extra[keys[currentStep]],
				showCancelButton: currentStep > 0,
				currentProgressStep: currentStep
			})

			if (result.value) {
				extra[keys[currentStep]] = result.value
				currentStep++
			} else if (result.dismiss === Swal.DismissReason.cancel) {
				currentStep--
			} else {
				break
			}
		}

		if (currentStep === steps.length) {
			Swal.fire({
				icon: 'info',
				title: 'Submitting',
				html: 'Please Wait!!!',
				position: 'center',
				showConfirmButton: false,
				allowOutsideClick: false,
				allowEscapeKey: false,
			});
			$.ajax({
				type: "POST",
				url: 'save_extra/',
				data: {
					quiz: "{{quiz.quiz_id}}",
					extra: JSON.stringify(extra),
					csrfmiddlewaretoken: $('input[name="csrfmiddlewaretoken"]').val()
				},
				success:function(success) {
					window.location.pathname = `{% url 'quiz' quiz.quiz_id %}`;
				},
				error:function(error) {
					Swal.close();
					if(error.status == 403 && error.responseJSON.error == "logged out") {
						Swal.fire({
							toast: true,
							position: 'top-end',
							icon: 'error',
							html: `You Have been logged out.<br>Please Login again.`,
							animation: true,
							timer: 3000,
							timerProgressBar: true,
							showConfirmButton: false,
						});
					} else {
						Swal.fire({
							toast: true,
							position: 'top-end',
							icon: 'error',
							html: `An Error Occured<br>Please Try Again`,
							animation: true,
							timer: 2000,
							timerProgressBar: true,
							showConfirmButton: false,
						});
					}
				}
			});
		}
		})() {% endcomment %}
	})


	{% comment %} let testStartBtn = document.getElementById("test-start-btn");
	testStartBtn.addEventListener("click", function(e){
		e.preventDefault();
		alertForFullScreen();
		openFullScreen();
		window.location.pathname=`/quiz/${quiz_id}`;
	});

	function alertForFullScreen(){
		Swal.fire({
			icon: 'info',
			title: 'Full Screen',
			html: 'You are required to enter in Full Screen',
			position: 'top',
			timerProgressBar: false,
			showConfirmButton: true,
			// timer: 1500
		});
	}

	function openFullScreen(){
		document.documentElement.requestFullscreen();
		let elem = document.documentElement;
		if (elem.requestFullscreen) {
			elem.requestFullscreen();
		} else if (elem.webkitRequestFullscreen) { /* Safari */
			elem.webkitRequestFullscreen();
		} else if (elem.msRequestFullscreen) { /* IE11 */
			elem.msRequestFullscreen();
		}
	} {% endcomment %}
</script>

{% endblock %}